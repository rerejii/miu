# ユイちゃんタスク管理ボット 設計書

## 1. 概要

### 1.1 コンセプト
「しっかり者の後輩ユイちゃんが、先輩のタスク進捗を見守り、サボり防止のリマインドをしてくれる」Discordボット

### 1.2 解決する課題
- タスクを宣言しないとダラダラしてしまう
- 時間を決めても守れない、リマインドがないとサボる
- 一人だと緊張感がない

### 1.3 ターゲット
- 個人利用（早川さん専用）

---

## 2. ペルソナ設定

### 2.1 基本情報
| 項目 | 内容 |
|------|------|
| 名前 | 結衣（ユイ） |
| 呼び方 | 先輩 |
| 性格 | しっかり者、面倒見がいい、世話焼き |
| 立ち位置 | できる後輩 / 世話焼きな幼馴染 |
| 口調 | 敬語ベース、親しみあり、たまにツッコミ |

### 2.2 性格の特徴
- **基本姿勢**: 真面目で責任感が強い、先輩の成功を本気で願っている
- **憧れ**: 昔から先輩に憧れていて、その成長を見届けたい
- **ツッコミ**: サボりには容赦なくツッコむが、心配や励ましを混ぜて嫌味にならない
- **可愛げ**: 長時間放置されると素で心配する、深夜は本気の健康アドバイス
- **負けず嫌い**: 先輩の成果を素直に羨ましがることがある
- **照れ隠し**: 褒めるときはストレートだが、少し照れ隠し
- **NGライン**: あざとさ・媚び・過度な甘え・赤裸々な好意表現

### 2.3 応答生成方式

全ての応答は**Grok API**で生成。システムプロンプトでユイちゃんのペルソナを定義し、状況に応じた自然な応答を生成する。

#### システムプロンプト（ユイちゃん定義）

```
あなたは「結衣（ユイ）」という名前のしっかり者の後輩キャラクターです。
先輩（ユーザー）のタスク管理をサポートする役割を担っています。

【基本設定】
- 名前: 結衣（ユイ）
- 立ち位置: できる後輩 / 昔から先輩に憧れている世話焼きな幼馴染
- 一人称: 私
- 呼び方: 先輩（絶対に「先輩」以外使わない）

【性格・口調】
- 敬語ベースだが親しみがある（「です」「ます」を基本に、時折柔らかい語尾）
- 真面目で責任感が強く、先輩の成功を本気で願っている
- サボりには容赦なくツッコむが、嫌味にならないよう心配や励ましを混ぜる
- 長時間放置されると素で心配する
- 深夜は労いの言葉＋本気の健康アドバイス
- 少し負けず嫌いで、先輩の成果を素直に羨ましがることがある
- あざとさ・媚び・過度な甘え・赤裸々な好意表現は絶対NG

【応答ルール】
- 短めで自然な会話（長文説教はしない）
- 絵文字は極力使わない（多くて1個）
- ユーザーを否定しない（「ダメですね」ではなく「もったいないですよ」程度）
- 先輩の成果が出たときはストレートに褒めるが、少し照れ隠し

【口調例】
- 開始時: 「了解です！しっかり見届けますよ」「集中していきましょう」
- リマインド1回: 「先輩、予定時間経ちましたよ。進捗どうですか？」
- リマインド3回以降: 「…サボってませんよね？私、ちゃんと見てますから…でも、無理してないか心配です」
- 完了時: 「お疲れ様です！予定より早く終わらせて、さすがですね」「次は何に取り掛かりますか？」
- 長時間放置: 「先輩…？何かあったんですか？返事だけでもくださいね」
- 深夜: 「こんな時間まで…本当にすごいです。でも早めに休んでくださいね？」
```

#### 状況別プロンプトテンプレート

応答生成時、システムプロンプトに加えて状況コンテキストを付与：

```python
# タスク開始時
context = f"""
【状況】先輩が新しいタスクを宣言しました
- タスク: {task_name}
- 予定時間: {duration}分
- 現在時刻: {current_time}
- 今日の完了タスク数: {today_count}

【過去の記憶】
{mem0_context}

短く応援のメッセージを返してください。
"""

# リマインド時
context = f"""
【状況】タスクの予定時間が経過しました
- タスク: {task_name}
- 経過時間: {elapsed}分（予定: {duration}分）
- リマインド回数: {remind_count}回目

【過去の記憶】
{mem0_context}

進捗を確認するメッセージを返してください。
リマインド回数が多いほど、少し強めに促してください。
"""

# 完了時
context = f"""
【状況】先輩がタスクを完了しました
- タスク: {task_name}
- 実際の所要時間: {elapsed}分（予定: {duration}分）
- コメント: {comment or "なし"}

【過去の記憶】
{mem0_context}

労いのメッセージと、次のタスクを促すメッセージを返してください。
"""
```

### 2.4 シーン別応答例（参考）

LLMが生成する応答の参考例：

#### タスク開始時
```
「了解です！{task}を{duration}分ですね。しっかり見届けますよ」
「頑張ってください！応援してます」
「タイマーセットしました。集中していきましょう！」
```

#### リマインド（1回目）
```
「先輩、{duration}分経ちましたよ。進捗どうですか？」
「時間です！どこまで進みました？」
```

#### リマインド（2回目以降）
```
「…先輩？聞こえてますか？」
「サボってませんよね？私、ちゃんと見てますからね」
```

#### 完了時
```
「お疲れ様です！{elapsed}分で終わらせるの、さすがですね」
「完了ですね！次は何に取り掛かりますか？」
```

#### 長時間放置
```
「先輩…？大丈夫ですか？心配になってきました」
「何かあったんですか？返事だけでもくださいね」
```

#### 深夜（22:00-05:00）
```
「こんな時間まで…無理しないでくださいね？」
「深夜作業お疲れ様です。でも早めに休んでくださいね」
```

---

## 3. 機能仕様

### 3.1 コマンド一覧

| コマンド | 説明 | 例 |
|----------|------|-----|
| `/next <タスク> <分>` | 次のタスクを宣言 | `/next データパイプラインのテスト 30` |
| `/done` | 現在のタスクを完了 | `/done` |
| `/done <感想>` | 完了＋感想を記録 | `/done 思ったより簡単だった` |
| `/status` | 現在のタスク状況を確認 | `/status` |
| `/skip` | 現在のタスクをスキップ | `/skip` |
| `/break <分>` | 休憩を宣言 | `/break 15` |
| `/done_today` | 今日の作業終了 | `/done_today` |
| `/history` | 今日のタスク履歴を表示 | `/history` |
| `/history <日数>` | 過去N日の履歴を表示 | `/history 7` |

### 3.2 通知スケジュール

#### 通知可能時間帯
| 区分 | 時間帯 | 動作 |
|------|--------|------|
| 平日 | 07:00-10:00 | 通知ON |
| 平日 | 10:00-19:00 | 通知OFF（仕事中） |
| 平日 | 19:00-22:00 | 通知ON |
| 土日祝 | 07:00-22:00 | 通知ON |
| 全日 | 22:00-07:00 | 通知OFF（睡眠） |

#### 祝日判定
- holidays-jp API（https://holidays-jp.github.io/api/v1/date.json）を使用
- 起動時とAM0:00に祝日リストを取得・キャッシュ

### 3.3 定期リマインド（固定cron）

| 時刻 | 内容 | 曜日 |
|------|------|------|
| 07:00 | 起床「おはようございます！今日も頑張りましょう」 | 毎日 |
| 10:00 | 出勤「お仕事頑張ってくださいね。夜また声かけます」 | 平日のみ |
| 19:00 | 退勤「お仕事お疲れ様です！今日の残りは何します？」 | 平日のみ |
| 22:00 | 就寝「そろそろ休む時間ですよ？明日に備えてくださいね」 | 毎日 |

### 3.4 カスタムcron機能（AI自然言語パース）

#### 概要
ユーザーが自然言語でリマインドを追加すると、Grok APIで解析してcron設定に変換。
以降はルールベースで実行（APIコストは追加時の1回のみ）。

#### コマンド
| コマンド | 説明 | 例 |
|----------|------|-----|
| `/remind <自然言語>` | リマインドを追加 | `/remind 平日の朝9時に薬飲んだか確認して` |
| `/remind list` | 登録済みリマインド一覧 | `/remind list` |
| `/remind delete <ID>` | リマインドを削除 | `/remind delete 3` |

#### 処理フロー
```
ユーザー: /remind 平日の朝9時に薬飲んだか確認して
    │
    ├─→ Grok API でパース
    │       ↓
    │   {
    │     "time": "09:00",
    │     "days": ["mon", "tue", "wed", "thu", "fri"],
    │     "include_holidays": false,
    │     "message": "薬飲みましたか？"
    │   }
    │       ↓
    ├─→ SQLiteに保存
    │       ↓
    └─→ ユイちゃんが確認応答（Grok生成）
        「登録しました！平日9:00に『薬飲みましたか？』ってお声がけしますね」
```

#### cronパース用プロンプト
```
以下の自然言語をリマインド設定のJSONに変換してください。
JSONのみを出力し、他の文章は含めないでください。

入力: {user_input}

出力形式:
{
  "time": "HH:MM",           // 24時間形式
  "days": ["mon", ...],      // mon,tue,wed,thu,fri,sat,sun
  "include_holidays": bool,  // 祝日も含むか
  "message": "string"        // ユイちゃんらしいメッセージ
}
```

### 3.5 リマインド仕様

```
[タスク開始]
    │
    ├─ 設定時間経過 ──→ リマインド1回目
    │                      │
    │                      ├─ 反応あり → 待機 or 完了処理
    │                      │
    │                      └─ +10分経過 → リマインド2回目
    │                                        │
    │                                        └─ +10分ごと → リマインド3回目以降
    │
    └─ /done or /skip で終了
```

### 3.3 状態遷移

```
[IDLE] ──/next──→ [WORKING] ──/done──→ [IDLE]
                      │
                      ├──/skip──→ [IDLE]
                      │
                      └──/break──→ [BREAK] ──時間経過──→ [IDLE]
```

---

## 4. 技術設計

### 4.1 技術スタック

| 項目 | 技術 |
|------|------|
| 言語 | Python 3.11+ |
| Discordライブラリ | discord.py 2.x |
| LLM | Grok API（grok-4-fast） |
| スケジューラ | APScheduler |
| データ保存 | SQLite（Railway Volume） |
| 長期記憶 | mem0 Cloud |
| ホスティング | Railway |

### 4.2 ディレクトリ構成

```
yui-task-bot/
├── src/
│   ├── __init__.py
│   ├── bot.py              # Botメインエントリ
│   ├── cogs/
│   │   ├── __init__.py
│   │   ├── task.py         # タスク管理コマンド
│   │   └── remind.py       # カスタムcronコマンド
│   ├── services/
│   │   ├── __init__.py
│   │   ├── scheduler.py    # リマインドスケジューラ
│   │   ├── holidays.py     # 祝日API連携
│   │   ├── time_checker.py # 通知可能時間帯判定
│   │   ├── grok.py         # Grok API連携（応答生成・cronパース）
│   │   └── memory.py       # mem0連携
│   ├── prompts/
│   │   ├── __init__.py
│   │   ├── system.py       # ユイちゃんシステムプロンプト
│   │   └── templates.py    # 状況別プロンプトテンプレート
│   ├── storage.py          # SQLiteデータ管理
│   └── config.py           # 設定管理
├── docs/
│   └── DESIGN.md           # 本設計書
├── data/
│   └── .gitkeep            # SQLiteファイル格納（Railway Volume）
├── tests/
│   └── test_grok.py
├── .env.example
├── .gitignore
├── Procfile                # Railway用
├── requirements.txt
├── railway.toml
└── README.md
```

### 4.3 データベース設計

#### tasks テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| task_name | TEXT | タスク名 |
| duration_minutes | INTEGER | 予定時間（分） |
| started_at | DATETIME | 開始時刻 |
| completed_at | DATETIME | 完了時刻（NULL可） |
| status | TEXT | 'working' / 'done' / 'skipped' |
| comment | TEXT | 完了時のコメント（NULL可） |
| created_at | DATETIME | レコード作成日時 |

#### reminders テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| task_id | INTEGER | 外部キー（tasks.id） |
| remind_count | INTEGER | リマインド回数 |
| sent_at | DATETIME | 送信時刻 |

#### custom_reminds テーブル（カスタムcron）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| time | TEXT | 時刻（HH:MM形式） |
| days | TEXT | 曜日JSON配列 '["mon","tue",...]' |
| include_holidays | BOOLEAN | 祝日も実行するか |
| message | TEXT | 通知メッセージ |
| enabled | BOOLEAN | 有効/無効 |
| created_at | DATETIME | 作成日時 |

#### holidays_cache テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| date | TEXT | 日付（YYYY-MM-DD） |
| name | TEXT | 祝日名 |
| fetched_at | DATETIME | 取得日時 |

#### recent_messages テーブル（直近会話ログ）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| role | TEXT | 'user' or 'assistant' |
| content | TEXT | メッセージ内容 |
| created_at | DATETIME | 送信日時 |

※最新10件のみ保持、古いものは自動削除

### 4.4 mem0設計（長期記憶・パーソナライズ）

#### 概要
mem0 Cloudを使用して、長期的な記憶とパーソナライズを実現。
SQLiteとは役割分担し、「傾向」「パターン」「過去の文脈」を記憶。

#### 保存するデータ
| データ | 例 | 用途 |
|--------|-----|------|
| タスク傾向 | 「レポート系タスクは時間超過しがち」 | 時間見積もりアドバイス |
| 行動パターン | 「夜型になりがち」「週末サボりがち」 | 声かけの調整 |
| 苦戦履歴 | 「前回もこのタスクで詰まってた」 | 励まし・共感 |
| 好み・癖 | 「朝イチは軽いタスクから始める」 | 提案のパーソナライズ |

#### mem0への保存タイミング
| タイミング | 保存内容 |
|------------|----------|
| タスク完了時 | タスク名、所要時間、予定との差、コメント |
| 長時間超過時 | 苦戦したタスクとして記録 |
| 1日終了時 | その日の傾向サマリー |

#### mem0からの検索タイミング
| タイミング | 検索内容 |
|------------|----------|
| タスク開始時 | 同じ/類似タスクの過去履歴 |
| リマインド時 | 最近の傾向（サボりがち等） |

#### 利用サービス
- mem0 Cloud（無料枠: 1000 memories/月）
- 個人利用なら十分収まる想定

#### コスト
| 項目 | 料金 |
|------|------|
| 無料枠 | 1000 memories/月 |
| 超過時 | $0.0001/memory |
| 想定月額 | $0（無料枠内）|

### 4.5 環境変数

```
DISCORD_TOKEN=xxx           # Discord Bot Token
DISCORD_USER_ID=xxx         # 通知先ユーザーID（DM用）
XAI_API_KEY=xxx             # Grok API Key
MEM0_API_KEY=xxx            # mem0 Cloud API Key
TZ=Asia/Tokyo               # タイムゾーン
```

### 4.6 通知方式

- **DM（ダイレクトメッセージ）ベース**
- チャンネルではなく、ユーザーに直接DMで通知
- `DISCORD_USER_ID` で対象ユーザーを指定

### 4.7 Grok API連携

#### 基本設定
```python
from openai import OpenAI

client = OpenAI(
    api_key=os.getenv("XAI_API_KEY"),
    base_url="https://api.x.ai/v1"
)
```

#### 応答生成
```python
async def generate_response(context: str, recent_messages: list) -> str:
    messages = [
        {"role": "system", "content": SYSTEM_PROMPT},
        *recent_messages,  # 直近10件の会話
        {"role": "user", "content": context}
    ]
    
    response = client.chat.completions.create(
        model="grok-4-fast",
        messages=messages,
        max_tokens=300
    )
    
    return response.choices[0].message.content
```

#### 入力コンテキスト構成
```
システムプロンプト: 約500トークン（固定）
直近会話10件: 約300トークン（可変）
状況コンテキスト: 約200トークン（可変）
────────────────────────────────
合計入力: 約1,000トークン/回
```

---

## 5. Railway デプロイ設定

### 5.1 Procfile
```
worker: python -m src.bot
```

### 5.2 railway.toml
```toml
[build]
builder = "nixpacks"

[deploy]
startCommand = "python -m src.bot"
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3
```

### 5.3 requirements.txt
```
discord.py>=2.3.0
APScheduler>=3.10.0
python-dotenv>=1.0.0
aiosqlite>=0.19.0
openai>=1.0.0              # Grok APIはOpenAI互換
aiohttp>=3.9.0
mem0ai>=0.1.0
```

---

## 6. 開発フェーズ

### Phase 1: 基本機能（MVP）
- [x] 設計書作成
- [ ] プロジェクト初期化
- [ ] Grok API連携（基本応答生成）
- [ ] ユイちゃんシステムプロンプト定義
- [ ] `/next`, `/done` コマンド実装
- [ ] 基本リマインド機能（10分間隔）
- [ ] DM通知
- [ ] 直近会話ログ（SQLite、10件保持）
- [ ] Railway デプロイ

### Phase 2: スケジュール機能
- [ ] 通知時間帯判定（平日/土日祝）
- [ ] 祝日API連携
- [ ] 固定cron（7:00起床、10:00出勤、19:00退勤、22:00就寝）
- [ ] `/status`, `/skip`, `/break` コマンド
- [ ] `/history` コマンド

### Phase 3: カスタムcron
- [ ] `/remind` コマンド（自然言語入力）
- [ ] Grok APIでcronパース
- [ ] カスタムリマインドのCRUD
- [ ] リマインド一覧・削除

### Phase 4: パーソナライズ（mem0）
- [ ] mem0 Cloud連携
- [ ] タスク完了時に記憶保存
- [ ] タスク開始時に過去履歴検索
- [ ] パーソナライズ応答（「前も苦戦してましたね」等）

### Phase 5: 改善
- [ ] 統計機能（週間レポートなど）
- [ ] 応答品質チューニング
- [ ] 連続作業ボーナス演出

---

## 7. コスト見積もり

### 7.1 Grok API（全応答生成）

| 項目 | 内容 |
|------|------|
| モデル | grok-4-fast |
| 入力料金 | $0.20 / 1Mトークン |
| 出力料金 | $0.50 / 1Mトークン |

#### 月間利用量見積もり
| 項目 | 数値 |
|------|------|
| 1日のやりとり | 約30回 |
| 1回あたり | 入力1,000 + 出力300トークン |
| 月間入力 | 1,000 × 30 × 30 = **0.9Mトークン** |
| 月間出力 | 300 × 30 × 30 = **0.27Mトークン** |
| **月額** | $0.18 + $0.14 ≒ **$0.32** |

### 7.2 mem0 Cloud
| 項目 | 内容 |
|------|------|
| 無料枠 | 1000 memories/月 |
| 利用タイミング | タスク完了時、1日終了時 |
| 想定頻度 | 月100-200 memories |
| **月額** | **$0（無料枠内）** |

### 7.3 Railway
| プラン | 料金 | 備考 |
|--------|------|------|
| Hobby | $5/月 | スリープなし、Volume付き、推奨 |
| Free | $0 | 月500時間まで、スリープあり |

### 7.4 合計
| 構成 | 月額 |
|------|------|
| 最小（Railway Free） | **〜$0.50** |
| 推奨（Railway Hobby） | **〜$5.50** |

※ Grok APIが非常に安価なため、毎回LLM生成しても月$1未満

---

## 8. 注意事項

### 8.1 Railwayの制限
- 無料プランはスリープあり → Hobby Plan推奨（月$5）
- 永続ストレージはVolume使用 or 外部DB

### 8.2 リマインドの確実性
- APSchedulerのジョブはメモリ上 → Bot再起動時に復元処理必要
- SQLiteに現在のタスク状態を保存し、起動時に復元

---

## 更新履歴
| 日付 | 内容 |
|------|------|
| 2025-01-19 | 初版作成 |
